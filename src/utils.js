// Elite Dangerous Materials Database
export const MATERIALS_DB = [
  { item: 'Anomalous Bulk Scan Data', type: 'Encoded (Data archives)', quality: 1, source: 'Ship scanning (Transport ships), Mission reward' },
  { item: 'Unidentified Scan Archives', type: 'Encoded (Data archives)', quality: 2, source: 'Ship scanning (Transport ships)' },
  { item: 'Classified Scan Databanks', type: 'Encoded (Data archives)', quality: 3, source: 'Ship scanning (Transport ships), Surface POI' },
  { item: 'Divergent Scan Data', type: 'Encoded (Data archives)', quality: 4, source: 'Surface data point, Mission reward' },
  { item: 'Classified Scan Fragment', type: 'Encoded (Data archives)', quality: 5, source: 'Surface data point, Mission reward, Ship scanning (Military & authority ships)' },
  { item: 'Exceptional Scrambled Emission Data', type: 'Encoded (Emission data)', quality: 1, source: 'Ship scanning, USS, Mission reward' },
  { item: 'Irregular Emission Data', type: 'Encoded (Emission data)', quality: 2, source: 'Mission reward, USS' },
  { item: 'Unexpected Emission Data', type: 'Encoded (Emission data)', quality: 3, source: 'Ship scanning (Combat ships), USS' },
  { item: 'Decoded Emission Data', type: 'Encoded (Emission data)', quality: 4, source: 'Ship scanning (Combat ships), Mission reward' },
  { item: 'Abnormal Compact Emissions Data', type: 'Encoded (Emission data)', quality: 5, source: 'USS (Encoded emissions), Ship scanning (Combat ships), Mission reward' },
  { item: 'Specialised Legacy Firmware', type: 'Encoded (Encoded Firmware)', quality: 1, source: 'Mission reward, Surface data point, USS' },
  { item: 'Modified Consumer Firmware', type: 'Encoded (Encoded Firmware)', quality: 2, source: 'Mission reward, USS, Surface data point' },
  { item: 'Cracked Industrial Firmware', type: 'Encoded (Encoded Firmware)', quality: 3, source: 'Surface data point, Mission reward' },
  { item: 'Security Firmware Patch', type: 'Encoded (Encoded Firmware)', quality: 4, source: 'Surface data point, Mission reward' },
  { item: 'Modified Embedded Firmware', type: 'Encoded (Encoded Firmware)', quality: 5, source: 'Surface data point, Mission reward' },
  { item: 'Unusual Encrypted Files', type: 'Encoded (Encryption files)', quality: 1, source: 'Surface data point, USS, Mission reward' },
  { item: 'Tagged Encryption Codes', type: 'Encoded (Encryption files)', quality: 2, source: 'Surface data point, USS, Mission reward' },
  { item: 'Open Symmetric Keys', type: 'Encoded (Encryption files)', quality: 3, source: 'Surface data point, USS, Mission reward' },
  { item: 'Atypical Encryption Archives', type: 'Encoded (Encryption files)', quality: 4, source: 'Surface POI' },
  { item: 'Adaptive Encryptors Capture', type: 'Encoded (Encryption files)', quality: 5, source: 'Surface POI, USS' },
  { item: 'Pattern Gamma Obelisk Data', type: 'Encoded (Guardian)', quality: 1, source: 'Ancient/Guardian ruins' },
  { item: 'Pattern Beta Obelisk Data', type: 'Encoded (Guardian)', quality: 2, source: 'Ancient/Guardian ruins' },
  { item: 'Pattern Alpha Obelisk Data', type: 'Encoded (Guardian)', quality: 3, source: 'Ancient/Guardian ruins' },
  { item: 'Pattern Delta Obelisk Data', type: 'Encoded (Guardian)', quality: 4, source: 'Ancient/Guardian ruins' },
  { item: 'Pattern Epsilon Obelisk Data', type: 'Encoded (Guardian)', quality: 4, source: 'Ancient/Guardian ruins' },
  { item: 'Guardian Module Blueprint Fragment', type: 'Encoded (Guardian)', quality: 5, source: 'Ancient/Guardian ruins' },
  { item: 'Guardian Vessel Blueprint Fragment', type: 'Encoded (Guardian)', quality: 5, source: 'Ancient/Guardian ruins' },
  { item: 'Guardian Weapon Blueprint Fragment', type: 'Encoded (Guardian)', quality: 5, source: 'Ancient/Guardian ruins' },
  { item: 'Distorted Shield Cycle Recordings', type: 'Encoded (Shield data)', quality: 1, source: 'Ship scanning (Transport ships), Mission reward' },
  { item: 'Inconsistent Shield Soak Analysis', type: 'Encoded (Shield data)', quality: 2, source: 'Ship scanning (Transport ships), Mission reward' },
  { item: 'Untypical Shield Scans', type: 'Encoded (Shield data)', quality: 3, source: 'Ship scanning (Combat ships)' },
  { item: 'Aberrant Shield Pattern Analysis', type: 'Encoded (Shield data)', quality: 4, source: 'Ship scanning (Combat ships), Mission reward' },
  { item: 'Peculiar Shield Frequency Data', type: 'Encoded (Shield data)', quality: 5, source: 'Ship scanning, Mission reward' },
  { item: 'Thargoid Structural Data', type: 'Encoded (Thargoid)', quality: 2, source: 'Thargoid site' },
  { item: 'Massive Energy Surge Analytics', type: 'Encoded (Thargoid)', quality: 3, source: 'Thargoid Maelstrom' },
  { item: 'Ship Flight Data', type: 'Encoded (Thargoid)', quality: 3, source: 'Thargoid ship encounter' },
  { item: 'Ship Systems Data', type: 'Encoded (Thargoid)', quality: 3, source: 'Thargoid ship encounter' },
  { item: 'Thargoid Interdiction Telemetry', type: 'Encoded (Thargoid)', quality: 3, source: 'Thargoid ship encounter' },
  { item: 'Thargoid Material Composition Data', type: 'Encoded (Thargoid)', quality: 3, source: 'Thargoid site' },
  { item: 'Thargoid Ship Signature', type: 'Encoded (Thargoid)', quality: 3, source: 'Thargoid ship encounter, Thargoid site' },
  { item: 'Thargoid Residue Data', type: 'Encoded (Thargoid)', quality: 4, source: 'Thargoid site' },
  { item: 'Thargoid Wake Data', type: 'Encoded (Thargoid)', quality: 4, source: 'Thargoid ship encounter' },
  { item: 'Atypical Disrupted Wake Echoes', type: 'Encoded (Wake scans)', quality: 1, source: 'High wake scanning, Mission reward' },
  { item: 'Anomalous FSD Telemetry', type: 'Encoded (Wake scans)', quality: 2, source: 'High wake scanning, Mission reward' },
  { item: 'Strange Wake Solutions', type: 'Encoded (Wake scans)', quality: 3, source: 'High wake scanning, Mission reward' },
  { item: 'Eccentric Hyperspace Trajectories', type: 'Encoded (Wake scans)', quality: 4, source: 'High wake scanning' },
  { item: 'Datamined Wake Exceptions', type: 'Encoded (Wake scans)', quality: 5, source: 'High wake scanning, Mission reward, USS (Encoded emissions)' },
  { item: 'Salvaged Alloys', type: 'Manufactured (Alloys)', quality: 1, source: 'Ship salvage (Combat ships), USS (Combat aftermath)' },
  { item: 'Galvanising Alloys', type: 'Manufactured (Alloys)', quality: 2, source: 'Ship salvage (Combat ships), USS, Mission reward' },
  { item: 'Phase Alloys', type: 'Manufactured (Alloys)', quality: 3, source: 'Ship salvage (Combat ships), USS' },
  { item: 'Proto Light Alloys', type: 'Manufactured (Alloys)', quality: 4, source: 'USS (High grade emissions), Mission reward' },
  { item: 'Proto Radiolic Alloys', type: 'Manufactured (Alloys)', quality: 5, source: 'USS (High grade emissions)' },
  { item: 'Grid Resistors', type: 'Manufactured (Capacitors)', quality: 1, source: 'Ship salvage (Military & authority ships), USS, Mission reward' },
  { item: 'Hybrid Capacitors', type: 'Manufactured (Capacitors)', quality: 2, source: 'Ship salvage (Military & authority ships), USS, Mission reward' },
  { item: 'Electrochemical Arrays', type: 'Manufactured (Capacitors)', quality: 3, source: 'Ship salvage (Military & authority ships), USS (Degraded emissions/Anarchy)' },
  { item: 'Polymer Capacitors', type: 'Manufactured (Capacitors)', quality: 4, source: 'Ship salvage (Military & authority ships), USS (Convoy dispersal pattern), Mission reward' },
  { item: 'Military Supercapacitors', type: 'Manufactured (Capacitors)', quality: 5, source: 'USS (High grade emissions)' },
  { item: 'Chemical Storage Units', type: 'Manufactured (Chemical)', quality: 1, source: 'Ship salvage (Transport ships)' },
  { item: 'Chemical Processors', type: 'Manufactured (Chemical)', quality: 2, source: 'Ship salvage (Transport ships), USS, Mission reward' },
  { item: 'Chemical Distillery', type: 'Manufactured (Chemical)', quality: 3, source: 'Ship salvage (Transport ships), USS' },
  { item: 'Chemical Manipulators', type: 'Manufactured (Chemical)', quality: 4, source: 'Ship salvage (Transport ships), Surface POI, USS (Convoy dispersal pattern)' },
  { item: 'Pharmaceutical Isolators', type: 'Manufactured (Chemical)', quality: 5, source: 'Mission reward, USS (High grade emissions)' },
  { item: 'Compact Composites', type: 'Manufactured (Composite)', quality: 1, source: 'USS, Surface POI' },
  { item: 'Filament Composites', type: 'Manufactured (Composite)', quality: 2, source: 'Ship salvage (Military & authority ships), USS' },
  { item: 'High Density Composites', type: 'Manufactured (Composite)', quality: 3, source: 'Ship salvage (Military & authority ships), USS' },
  { item: 'Proprietary Composites', type: 'Manufactured (Composite)', quality: 4, source: 'USS (Encoded emissions), USS (High grade emissions), Mission reward' },
  { item: 'Core Dynamics Composites', type: 'Manufactured (Composite)', quality: 5, source: 'Ship salvage (Combat ships), USS (High grade emissions)' },
  { item: 'Basic Conductors', type: 'Manufactured (Conductive)', quality: 1, source: 'Ship salvage (Transport ships)' },
  { item: 'Conductive Components', type: 'Manufactured (Conductive)', quality: 2, source: 'Ship salvage (Transport ships), USS (Degraded emissions/Anarchy)' },
  { item: 'Conductive Ceramics', type: 'Manufactured (Conductive)', quality: 3, source: 'Ship salvage (Transport ships), USS (Degraded emissions/Anarchy)' },
  { item: 'Conductive Polymers', type: 'Manufactured (Conductive)', quality: 4, source: 'Ship salvage (Transport ships), Surface POI, Mission reward' },
  { item: 'Biotech Conductors', type: 'Manufactured (Conductive)', quality: 5, source: 'Mission reward' },
  { item: 'Crystal Shards', type: 'Manufactured (Crystals)', quality: 1, source: 'Ship salvage (Combat ships), Surface POI' },
  { item: 'Flawed Focus Crystals', type: 'Manufactured (Crystals)', quality: 2, source: 'Ship salvage (Combat ships), USS (Combat aftermath)' },
  { item: 'Focus Crystals', type: 'Manufactured (Crystals)', quality: 3, source: 'Ship salvage (Combat ships), USS' },
  { item: 'Refined Focus Crystals', type: 'Manufactured (Crystals)', quality: 4, source: 'Mission reward, USS (Weapons fire)' },
  { item: 'Exquisite Focus Crystals', type: 'Manufactured (Crystals)', quality: 5, source: 'Mission reward, Ship salvage (Combat ships)' },
  { item: 'Guardian Power Cell', type: 'Manufactured (Guardian)', quality: 1, source: 'Ancient/Guardian ruins' },
  { item: 'Guardian Wreckage Components', type: 'Manufactured (Guardian)', quality: 1, source: 'Ancient/Guardian ruins' },
  { item: 'Guardian Power Conduit', type: 'Manufactured (Guardian)', quality: 2, source: 'Ancient/Guardian ruins' },
  { item: 'Guardian Sentinel Weapon Parts', type: 'Manufactured (Guardian)', quality: 3, source: 'Ancient/Guardian ruins' },
  { item: 'Guardian Technology Component', type: 'Manufactured (Guardian)', quality: 3, source: 'Ancient/Guardian ruins' },
  { item: 'Heat Conduction Wiring', type: 'Manufactured (Heat)', quality: 1, source: 'Ship salvage (Transport ships), USS, Mission reward' },
  { item: 'Heat Dispersion Plate', type: 'Manufactured (Heat)', quality: 2, source: 'Ship salvage (Transport ships), USS, Mission reward' },
  { item: 'Heat Exchangers', type: 'Manufactured (Heat)', quality: 3, source: 'Ship salvage (Transport ships), USS (Degraded emissions/Anarchy)' },
  { item: 'Heat Vanes', type: 'Manufactured (Heat)', quality: 4, source: 'Ship salvage (Transport ships), USS, Mission reward' },
  { item: 'Proto Heat Radiators', type: 'Manufactured (Heat)', quality: 5, source: 'USS (High grade emissions), Mission reward' },
  { item: 'Mechanical Scrap', type: 'Manufactured (Mechanical components)', quality: 1, source: 'Ship salvage (Transport ships), USS, Mission reward' },
  { item: 'Mechanical Equipment', type: 'Manufactured (Mechanical components)', quality: 2, source: 'Ship salvage (Transport ships), USS' },
  { item: 'Mechanical Components', type: 'Manufactured (Mechanical components)', quality: 3, source: 'Ship salvage (Transport ships), USS (Combat aftermath)' },
  { item: 'Configurable Components', type: 'Manufactured (Mechanical components)', quality: 4, source: 'Ship salvage (Transport ships), USS (Combat aftermath), USS (Encoded emissions)' },
  { item: 'Improvised Components', type: 'Manufactured (Mechanical components)', quality: 5, source: 'USS (High grade emissions), Mission reward' },
  { item: 'Worn Shield Emitters', type: 'Manufactured (Shielding)', quality: 1, source: 'Ship salvage (Combat ships), USS' },
  { item: 'Shield Emitters', type: 'Manufactured (Shielding)', quality: 2, source: 'Ship salvage (Combat ships), USS' },
  { item: 'Shielding Sensors', type: 'Manufactured (Shielding)', quality: 3, source: 'Ship salvage (Combat ships), USS, Mission reward' },
  { item: 'Compound Shielding', type: 'Manufactured (Shielding)', quality: 4, source: 'Ship salvage (Combat ships), USS (Encoded emissions), Mission reward' },
  { item: 'Imperial Shielding', type: 'Manufactured (Shielding)', quality: 5, source: 'USS (High grade emissions), Mission reward' },
  { item: 'Hardened Surface Fragments', type: 'Manufactured (Thargoid)', quality: 1, source: 'Thargoid Titan' },
  { item: 'Caustic Shard', type: 'Manufactured (Thargoid)', quality: 2, source: 'Thargoid Maelstrom, Thargoid Titan debris field' },
  { item: 'Tactical Core Chip', type: 'Manufactured (Thargoid)', quality: 2, source: 'Thargoid Revenant' },
  { item: 'Thargoid Carapace', type: 'Manufactured (Thargoid)', quality: 2, source: 'Thargoid site, Thargoid Titan debris field' },
  { item: 'Bio-Mechanical Conduits', type: 'Manufactured (Thargoid)', quality: 3, source: 'Thargoid ship encounter' },
  { item: 'Corrosive Mechanisms', type: 'Manufactured (Thargoid)', quality: 3, source: 'Thargoid Caustic Generator, Thargoid Titan debris field' },
  { item: 'Phasing Membrane Residue', type: 'Manufactured (Thargoid)', quality: 3, source: 'Thargoid Titan' },
  { item: 'Thargoid Energy Cell', type: 'Manufactured (Thargoid)', quality: 3, source: 'Thargoid site' },
  { item: 'Wreckage Components', type: 'Manufactured (Thargoid)', quality: 3, source: 'Thargoid ship encounter, Thargoid Titan debris field' },
  { item: 'Caustic Crystal', type: 'Manufactured (Thargoid)', quality: 4, source: 'Thargoid Maelstrom, Thargoid Titan debris field' },
  { item: 'Thargoid Technological Components', type: 'Manufactured (Thargoid)', quality: 4, source: 'Thargoid site' },
  { item: 'Weapon Parts', type: 'Manufactured (Thargoid)', quality: 4, source: 'Thargoid ship encounter' },
  { item: 'Heat Exposure Specimen', type: 'Manufactured (Thargoid)', quality: 5, source: 'Thargoid Titan' },
  { item: 'Propulsion Elements', type: 'Manufactured (Thargoid)', quality: 5, source: 'Thargoid Caustic Generator, Thargoid Titan debris field, Thargoid ship encounter' },
  { item: 'Sensor Fragment', type: 'Manufactured (Thargoid)', quality: 5, source: 'Destroyed Unknown artefact, USS (Non-Human), Thargoid site' },
  { item: 'Thargoid Organic Circuitry', type: 'Manufactured (Thargoid)', quality: 5, source: 'Thargoid site, Thargoid Titan debris field' },
  { item: 'Tempered Alloys', type: 'Manufactured (Thermic)', quality: 1, source: 'Ship salvage (Combat ships)' },
  { item: 'Heat Resistant Ceramics', type: 'Manufactured (Thermic)', quality: 2, source: 'Ship salvage (Military & authority ships)' },
  { item: 'Precipitated Alloys', type: 'Manufactured (Thermic)', quality: 3, source: 'Ship salvage (Military & authority ships), Mission reward' },
  { item: 'Thermic Alloys', type: 'Manufactured (Thermic)', quality: 4, source: 'Ship salvage (Combat ships), Mission reward' },
  { item: 'Military Grade Alloys', type: 'Manufactured (Thermic)', quality: 5, source: 'USS (High grade emissions), Mission reward' },
  { item: 'Carbon', type: 'Raw (Raw material 1)', quality: 1, source: 'Surface prospecting, Mining, Mining (Ice rings)' },
  { item: 'Vanadium', type: 'Raw (Raw material 1)', quality: 2, source: 'Surface prospecting, Mining (Ice rings)' },
  { item: 'Niobium', type: 'Raw (Raw material 1)', quality: 3, source: 'Surface prospecting, Mission reward' },
  { item: 'Yttrium', type: 'Raw (Raw material 1)', quality: 4, source: 'Surface prospecting' },
  { item: 'Phosphorus', type: 'Raw (Raw material 2)', quality: 1, source: 'Surface prospecting, Mining, Mining (Ice rings)' },
  { item: 'Chromium', type: 'Raw (Raw material 2)', quality: 2, source: 'Surface prospecting, Mining (Ice rings)' },
  { item: 'Molybdenum', type: 'Raw (Raw material 2)', quality: 3, source: 'Surface prospecting, Mission reward' },
  { item: 'Technetium', type: 'Raw (Raw material 2)', quality: 4, source: 'Surface prospecting' },
  { item: 'Sulphur', type: 'Raw (Raw material 3)', quality: 1, source: 'Surface prospecting, Mining, Mining (Ice rings)' },
  { item: 'Manganese', type: 'Raw (Raw material 3)', quality: 2, source: 'Surface prospecting, Mission reward' },
  { item: 'Cadmium', type: 'Raw (Raw material 3)', quality: 3, source: 'Surface prospecting, Mining' },
  { item: 'Ruthenium', type: 'Raw (Raw material 3)', quality: 4, source: 'Surface prospecting' },
  { item: 'Iron', type: 'Raw (Raw material 4)', quality: 1, source: 'Surface prospecting, Mining, Mining (Ice rings)' },
  { item: 'Zinc', type: 'Raw (Raw material 4)', quality: 2, source: 'Surface prospecting' },
  { item: 'Tin', type: 'Raw (Raw material 4)', quality: 3, source: 'Surface prospecting' },
  { item: 'Selenium', type: 'Raw (Raw material 4)', quality: 4, source: 'Surface prospecting, Mission reward' },
  { item: 'Nickel', type: 'Raw (Raw material 5)', quality: 1, source: 'Surface prospecting, Mining, Mining (Ice rings)' },
  { item: 'Germanium', type: 'Raw (Raw material 5)', quality: 2, source: 'Surface prospecting, Mission reward' },
  { item: 'Tungsten', type: 'Raw (Raw material 5)', quality: 3, source: 'Surface prospecting' },
  { item: 'Tellurium', type: 'Raw (Raw material 5)', quality: 4, source: 'Surface prospecting' },
  { item: 'Rhenium', type: 'Raw (Raw material 6)', quality: 1, source: 'Mining' },
  { item: 'Arsenic', type: 'Raw (Raw material 6)', quality: 2, source: 'Surface prospecting, Mining, Mission reward' },
  { item: 'Mercury', type: 'Raw (Raw material 6)', quality: 3, source: 'Surface prospecting' },
  { item: 'Polonium', type: 'Raw (Raw material 6)', quality: 4, source: 'Surface prospecting, Mission reward' },
  { item: 'Lead', type: 'Raw (Raw material 7)', quality: 1, source: 'Mining' },
  { item: 'Zirconium', type: 'Raw (Raw material 7)', quality: 2, source: 'Surface prospecting, Mining' },
  { item: 'Boron', type: 'Raw (Raw material 7)', quality: 3, source: 'Mining' },
  { item: 'Antimony', type: 'Raw (Raw material 7)', quality: 4, source: 'Surface prospecting' },
];

// Engineering Blueprints Database
export const BLUEPRINTS_DB = {
  'FSD': {
    name: 'Frame Shift Drive',
    blueprints: {
      'Increased Range': {
        grades: {
          1: [{ item: 'Atypical Disrupted Wake Echoes', qty: 1 }],
          2: [{ item: 'Atypical Disrupted Wake Echoes', qty: 1 }, { item: 'Chemical Processors', qty: 1 }],
          3: [{ item: 'Phosphorus', qty: 1 }, { item: 'Chemical Processors', qty: 1 }, { item: 'Strange Wake Solutions', qty: 1 }],
          4: [{ item: 'Manganese', qty: 1 }, { item: 'Chemical Distillery', qty: 1 }, { item: 'Eccentric Hyperspace Trajectories', qty: 1 }],
          5: [{ item: 'Arsenic', qty: 1 }, { item: 'Chemical Manipulators', qty: 1 }, { item: 'Datamined Wake Exceptions', qty: 1 }]
        }
      },
      'Faster Boot': {
        grades: {
          1: [{ item: 'Grid Resistors', qty: 1 }],
          2: [{ item: 'Grid Resistors', qty: 1 }, { item: 'Chromium', qty: 1 }],
          3: [{ item: 'Grid Resistors', qty: 1 }, { item: 'Heat Dispersion Plate', qty: 1 }, { item: 'Selenium', qty: 1 }],
          4: [{ item: 'Hybrid Capacitors', qty: 1 }, { item: 'Heat Exchangers', qty: 1 }, { item: 'Cadmium', qty: 1 }],
          5: [{ item: 'Electrochemical Arrays', qty: 1 }, { item: 'Heat Vanes', qty: 1 }, { item: 'Tellurium', qty: 1 }]
        }
      },
      'Shielded': {
        grades: {
          1: [{ item: 'Nickel', qty: 1 }],
          2: [{ item: 'Carbon', qty: 1 }, { item: 'Shield Emitters', qty: 1 }],
          3: [{ item: 'Carbon', qty: 1 }, { item: 'Zinc', qty: 1 }, { item: 'Shielding Sensors', qty: 1 }],
          4: [{ item: 'Vanadium', qty: 1 }, { item: 'High Density Composites', qty: 1 }, { item: 'Compound Shielding', qty: 1 }],
          5: [{ item: 'Tungsten', qty: 1 }, { item: 'Proprietary Composites', qty: 1 }, { item: 'Imperial Shielding', qty: 1 }]
        }
      }
    }
  },
  'Thrusters': {
    name: 'Thrusters',
    blueprints: {
      'Dirty Drives': {
        grades: {
          1: [{ item: 'Specialised Legacy Firmware', qty: 1 }],
          2: [{ item: 'Specialised Legacy Firmware', qty: 1 }, { item: 'Mechanical Equipment', qty: 1 }],
          3: [{ item: 'Specialised Legacy Firmware', qty: 1 }, { item: 'Chromium', qty: 1 }, { item: 'Mechanical Components', qty: 1 }],
          4: [{ item: 'Modified Consumer Firmware', qty: 1 }, { item: 'Selenium', qty: 1 }, { item: 'Configurable Components', qty: 1 }],
          5: [{ item: 'Cracked Industrial Firmware', qty: 1 }, { item: 'Cadmium', qty: 1 }, { item: 'Pharmaceutical Isolators', qty: 1 }]
        }
      },
      'Clean Drives': {
        grades: {
          1: [{ item: 'Sulphur', qty: 1 }],
          2: [{ item: 'Specialised Legacy Firmware', qty: 1 }, { item: 'Conductive Components', qty: 1 }],
          3: [{ item: 'Specialised Legacy Firmware', qty: 1 }, { item: 'Conductive Components', qty: 1 }, { item: 'Unexpected Emission Data', qty: 1 }],
          4: [{ item: 'Modified Consumer Firmware', qty: 1 }, { item: 'Conductive Ceramics', qty: 1 }, { item: 'Decoded Emission Data', qty: 1 }],
          5: [{ item: 'Conductive Polymers', qty: 1 }, { item: 'Tin', qty: 1 }, { item: 'Abnormal Compact Emissions Data', qty: 1 }]
        }
      },
      'Drive Strengthening': {
        grades: {
          1: [{ item: 'Carbon', qty: 1 }],
          2: [{ item: 'Heat Conduction Wiring', qty: 1 }, { item: 'Vanadium', qty: 1 }],
          3: [{ item: 'Heat Conduction Wiring', qty: 1 }, { item: 'Vanadium', qty: 1 }, { item: 'High Density Composites', qty: 1 }],
          4: [{ item: 'Heat Dispersion Plate', qty: 1 }, { item: 'High Density Composites', qty: 1 }, { item: 'Cadmium', qty: 1 }],
          5: [{ item: 'Heat Exchangers', qty: 1 }, { item: 'Proprietary Composites', qty: 1 }, { item: 'Tin', qty: 1 }]
        }
      }
    }
  },
  'Power Plant': {
    name: 'Power Plant',
    blueprints: {
      'Overcharged': {
        grades: {
          1: [{ item: 'Sulphur', qty: 1 }],
          2: [{ item: 'Heat Conduction Wiring', qty: 1 }, { item: 'Conductive Components', qty: 1 }],
          3: [{ item: 'Heat Conduction Wiring', qty: 1 }, { item: 'Conductive Components', qty: 1 }, { item: 'Selenium', qty: 1 }],
          4: [{ item: 'Heat Dispersion Plate', qty: 1 }, { item: 'Conductive Ceramics', qty: 1 }, { item: 'Cadmium', qty: 1 }],
          5: [{ item: 'Conductive Polymers', qty: 1 }, { item: 'Chemical Manipulators', qty: 1 }, { item: 'Tellurium', qty: 1 }]
        }
      },
      'Armoured': {
        grades: {
          1: [{ item: 'Worn Shield Emitters', qty: 1 }],
          2: [{ item: 'Carbon', qty: 1 }, { item: 'Shield Emitters', qty: 1 }],
          3: [{ item: 'Carbon', qty: 1 }, { item: 'Shield Emitters', qty: 1 }, { item: 'High Density Composites', qty: 1 }],
          4: [{ item: 'Vanadium', qty: 1 }, { item: 'Shielding Sensors', qty: 1 }, { item: 'Proprietary Composites', qty: 1 }],
          5: [{ item: 'Tungsten', qty: 1 }, { item: 'Compound Shielding', qty: 1 }, { item: 'Core Dynamics Composites', qty: 1 }]
        }
      },
      'Low Emissions': {
        grades: {
          1: [{ item: 'Iron', qty: 1 }],
          2: [{ item: 'Iron', qty: 1 }, { item: 'Irregular Emission Data', qty: 1 }],
          3: [{ item: 'Iron', qty: 1 }, { item: 'Irregular Emission Data', qty: 1 }, { item: 'Heat Exchangers', qty: 1 }],
          4: [{ item: 'Germanium', qty: 1 }, { item: 'Unexpected Emission Data', qty: 1 }, { item: 'Heat Vanes', qty: 1 }],
          5: [{ item: 'Niobium', qty: 1 }, { item: 'Decoded Emission Data', qty: 1 }, { item: 'Proto Heat Radiators', qty: 1 }]
        }
      }
    }
  },
  'Shield Generator': {
    name: 'Shield Generator',
    blueprints: {
      'Reinforced': {
        grades: {
          1: [{ item: 'Phosphorus', qty: 1 }],
          2: [{ item: 'Phosphorus', qty: 1 }, { item: 'Conductive Components', qty: 1 }],
          3: [{ item: 'Phosphorus', qty: 1 }, { item: 'Conductive Components', qty: 1 }, { item: 'Mechanical Components', qty: 1 }],
          4: [{ item: 'Manganese', qty: 1 }, { item: 'Conductive Ceramics', qty: 1 }, { item: 'Configurable Components', qty: 1 }],
          5: [{ item: 'Arsenic', qty: 1 }, { item: 'Conductive Polymers', qty: 1 }, { item: 'Improvised Components', qty: 1 }]
        }
      },
      'Thermal Resistant': {
        grades: {
          1: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }],
          2: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Germanium', qty: 1 }],
          3: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Germanium', qty: 1 }, { item: 'Selenium', qty: 1 }],
          4: [{ item: 'Inconsistent Shield Soak Analysis', qty: 1 }, { item: 'Focus Crystals', qty: 1 }, { item: 'Mercury', qty: 1 }],
          5: [{ item: 'Untypical Shield Scans', qty: 1 }, { item: 'Refined Focus Crystals', qty: 1 }, { item: 'Ruthenium', qty: 1 }]
        }
      },
      'Enhanced Low Power': {
        grades: {
          1: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }],
          2: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Germanium', qty: 1 }],
          3: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Germanium', qty: 1 }, { item: 'Phosphorus', qty: 1 }],
          4: [{ item: 'Inconsistent Shield Soak Analysis', qty: 1 }, { item: 'Niobium', qty: 1 }, { item: 'Conductive Polymers', qty: 1 }],
          5: [{ item: 'Untypical Shield Scans', qty: 1 }, { item: 'Tin', qty: 1 }, { item: 'Biotech Conductors', qty: 1 }]
        }
      }
    }
  },
  'Shield Booster': {
    name: 'Shield Booster',
    blueprints: {
      'Heavy Duty': {
        grades: {
          1: [{ item: 'Grid Resistors', qty: 1 }],
          2: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Hybrid Capacitors', qty: 1 }],
          3: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Hybrid Capacitors', qty: 1 }, { item: 'Niobium', qty: 1 }],
          4: [{ item: 'Inconsistent Shield Soak Analysis', qty: 1 }, { item: 'Electrochemical Arrays', qty: 1 }, { item: 'Tin', qty: 1 }],
          5: [{ item: 'Untypical Shield Scans', qty: 1 }, { item: 'Polymer Capacitors', qty: 1 }, { item: 'Antimony', qty: 1 }]
        }
      },
      'Resistance Augmented': {
        grades: {
          1: [{ item: 'Phosphorus', qty: 1 }],
          2: [{ item: 'Phosphorus', qty: 1 }, { item: 'Conductive Components', qty: 1 }],
          3: [{ item: 'Phosphorus', qty: 1 }, { item: 'Conductive Components', qty: 1 }, { item: 'Focus Crystals', qty: 1 }],
          4: [{ item: 'Manganese', qty: 1 }, { item: 'Conductive Ceramics', qty: 1 }, { item: 'Refined Focus Crystals', qty: 1 }],
          5: [{ item: 'Conductive Polymers', qty: 1 }, { item: 'Refined Focus Crystals', qty: 1 }, { item: 'Imperial Shielding', qty: 1 }]
        }
      },
      'Thermal Resistant': {
        grades: {
          1: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }],
          2: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Heat Resistant Ceramics', qty: 1 }],
          3: [{ item: 'Distorted Shield Cycle Recordings', qty: 1 }, { item: 'Heat Resistant Ceramics', qty: 1 }, { item: 'Heat Dispersion Plate', qty: 1 }],
          4: [{ item: 'Inconsistent Shield Soak Analysis', qty: 1 }, { item: 'Precipitated Alloys', qty: 1 }, { item: 'Heat Exchangers', qty: 1 }],
          5: [{ item: 'Untypical Shield Scans', qty: 1 }, { item: 'Thermic Alloys', qty: 1 }, { item: 'Heat Vanes', qty: 1 }]
        }
      }
    }
  },
  'Armour': {
    name: 'Armour',
    blueprints: {
      'Heavy Duty': {
        grades: {
          1: [{ item: 'Carbon', qty: 1 }],
          2: [{ item: 'Carbon', qty: 1 }, { item: 'Shield Emitters', qty: 1 }],
          3: [{ item: 'Carbon', qty: 1 }, { item: 'Shield Emitters', qty: 1 }, { item: 'High Density Composites', qty: 1 }],
          4: [{ item: 'Vanadium', qty: 1 }, { item: 'Shielding Sensors', qty: 1 }, { item: 'Proprietary Composites', qty: 1 }],
          5: [{ item: 'Tungsten', qty: 1 }, { item: 'Compound Shielding', qty: 1 }, { item: 'Core Dynamics Composites', qty: 1 }]
        }
      },
      'Lightweight': {
        grades: {
          1: [{ item: 'Iron', qty: 1 }],
          2: [{ item: 'Iron', qty: 1 }, { item: 'Conductive Components', qty: 1 }],
          3: [{ item: 'Iron', qty: 1 }, { item: 'Conductive Components', qty: 1 }, { item: 'High Density Composites', qty: 1 }],
          4: [{ item: 'Germanium', qty: 1 }, { item: 'Conductive Ceramics', qty: 1 }, { item: 'Proprietary Composites', qty: 1 }],
          5: [{ item: 'Conductive Polymers', qty: 1 }, { item: 'Tin', qty: 1 }, { item: 'Military Grade Alloys', qty: 1 }]
        }
      },
      'Thermal Resistant': {
        grades: {
          1: [{ item: 'Heat Conduction Wiring', qty: 1 }],
          2: [{ item: 'Nickel', qty: 1 }, { item: 'Heat Dispersion Plate', qty: 1 }],
          3: [{ item: 'Vanadium', qty: 1 }, { item: 'Heat Dispersion Plate', qty: 1 }, { item: 'Heat Exchangers', qty: 1 }],
          4: [{ item: 'Tungsten', qty: 1 }, { item: 'Heat Exchangers', qty: 1 }, { item: 'Heat Vanes', qty: 1 }],
          5: [{ item: 'Molybdenum', qty: 1 }, { item: 'Heat Vanes', qty: 1 }, { item: 'Proto Heat Radiators', qty: 1 }]
        }
      }
    }
  },
  'Power Distributor': {
    name: 'Power Distributor',
    blueprints: {
      'Charge Enhanced': {
        grades: {
          1: [{ item: 'Specialised Legacy Firmware', qty: 1 }],
          2: [{ item: 'Specialised Legacy Firmware', qty: 1 }, { item: 'Conductive Components', qty: 1 }],
          3: [{ item: 'Grid Resistors', qty: 1 }, { item: 'Modified Consumer Firmware', qty: 1 }, { item: 'Conductive Ceramics', qty: 1 }],
          4: [{ item: 'Hybrid Capacitors', qty: 1 }, { item: 'Cracked Industrial Firmware', qty: 1 }, { item: 'Conductive Polymers', qty: 1 }],
          5: [{ item: 'Modified Embedded Firmware', qty: 1 }, { item: 'Conductive Polymers', qty: 1 }, { item: 'Exquisite Focus Crystals', qty: 1 }]
        }
      },
      'Engine Focused': {
        grades: {
          1: [{ item: 'Sulphur', qty: 1 }],
          2: [{ item: 'Sulphur', qty: 1 }, { item: 'Conductive Components', qty: 1 }],
          3: [{ item: 'Exceptional Scrambled Emission Data', qty: 1 }, { item: 'Chromium', qty: 1 }, { item: 'Electrochemical Arrays', qty: 1 }],
          4: [{ item: 'Irregular Emission Data', qty: 1 }, { item: 'Selenium', qty: 1 }, { item: 'Polymer Capacitors', qty: 1 }],
          5: [{ item: 'Unexpected Emission Data', qty: 1 }, { item: 'Cadmium', qty: 1 }, { item: 'Military Supercapacitors', qty: 1 }]
        }
      },
      'Weapon Focused': {
        grades: {
          1: [{ item: 'Sulphur', qty: 1 }],
          2: [{ item: 'Sulphur', qty: 1 }, { item: 'Hybrid Capacitors', qty: 1 }],
          3: [{ item: 'Exceptional Scrambled Emission Data', qty: 1 }, { item: 'Hybrid Capacitors', qty: 1 }, { item: 'Selenium', qty: 1 }],
          4: [{ item: 'Irregular Emission Data', qty: 1 }, { item: 'Electrochemical Arrays', qty: 1 }, { item: 'Cadmium', qty: 1 }],
          5: [{ item: 'Unexpected Emission Data', qty: 1 }, { item: 'Polymer Capacitors', qty: 1 }, { item: 'Tellurium', qty: 1 }]
        }
      }
    }
  }
};

// Reroll strategies - number of rolls per grade
export const REROLL_STRATEGIES = {
  single: {
    name: 'Single',
    rolls: { 1: 1, 2: 1, 3: 1, 4: 1, 5: 1 }
  },
  minimum: {
    name: 'Minimum',
    rolls: { 1: 1, 2: 1, 3: 3, 4: 4, 5: 6 }
  },
  typical: {
    name: 'Typical',
    rolls: { 1: 1, 2: 2, 3: 4, 4: 8, 5: 10 }
  },
  maximum: {
    name: 'Maximum',
    rolls: { 1: 2, 2: 3, 3: 5, 4: 10, 5: 12 }
  }
};

// Trade ratios
export const TRADE_UP_COST = 6;
export const TRADE_DOWN_YIELD = 3;
export const TRADE_ACROSS_COST = 6;

// Helper functions
export function getMaterial(itemName) {
  return MATERIALS_DB.find(m => m.item === itemName);
}

export function getMaterialsAtTypeQuality(type, quality) {
  return MATERIALS_DB.filter(m => m.type === type && m.quality === quality);
}

export function getMainCategory(type) {
  // Extract the main category: "Encoded", "Manufactured", or "Raw"
  if (type.startsWith('Encoded')) return 'Encoded';
  if (type.startsWith('Manufactured')) return 'Manufactured';
  if (type.startsWith('Raw')) return 'Raw';
  return type; // Fallback for unknown types
}

export function getConversionCost(fromType, fromQuality, toType, toQuality) {
  // Cannot trade between different main categories (Encoded, Manufactured, Raw)
  if (getMainCategory(fromType) !== getMainCategory(toType)) {
    return Infinity; // Impossible trade
  }

  let cost = 1;
  let currentQuality = fromQuality;

  while (currentQuality !== toQuality) {
    if (currentQuality < toQuality) {
      cost *= TRADE_UP_COST;
      currentQuality++;
    } else {
      cost /= TRADE_DOWN_YIELD;
      currentQuality--;
    }
  }

  if (fromType !== toType) {
    cost *= TRADE_ACROSS_COST;
  }

  return cost;
}

export function optimizeTrading(inventory, needs) {
  const inv = JSON.parse(JSON.stringify(inventory));
  const req = JSON.parse(JSON.stringify(needs));
  const trades = [];
  const fulfilled = [];
  const unfulfilled = [];

  // Direct fulfillment
  for (const need of req) {
    const match = inv.find(i => i.item === need.item);
    if (match && match.quantity > 0) {
      const take = Math.min(match.quantity, need.quantity);
      match.quantity -= take;
      need.quantity -= take;
      if (take > 0) {
        fulfilled.push({
          item: need.item,
          quantity: take,
          method: 'DIRECT',
          material: getMaterial(need.item)
        });
      }
    }
  }

  // Same type/quality matches
  for (const need of req) {
    if (need.quantity <= 0) continue;
    const needMat = getMaterial(need.item);

    for (const source of inv) {
      if (source.quantity <= 0) continue;
      const srcMat = getMaterial(source.item);

      if (srcMat.type === needMat.type && srcMat.quality === needMat.quality && srcMat.item !== needMat.item) {
        const take = Math.min(source.quantity, need.quantity);
        source.quantity -= take;
        need.quantity -= take;
        if (take > 0) {
          fulfilled.push({
            item: need.item,
            quantity: take,
            method: 'SAME_SLOT',
            from: source.item,
            material: needMat
          });
          trades.push({
            action: 'SAME_SLOT_TRADE',
            input: { item: source.item, type: srcMat.type, quality: srcMat.quality, amount: take },
            output: { item: need.item, type: needMat.type, quality: needMat.quality, amount: take },
            ratio: '1:1'
          });
        }
      }
    }
  }

  // Type conversions
  for (const need of req) {
    if (need.quantity <= 0) continue;
    const needMat = getMaterial(need.item);

    const options = [];

    for (const source of inv) {
      if (source.quantity <= 0) continue;
      const srcMat = getMaterial(source.item);
      if (srcMat.item === needMat.item) continue;

      const costPerUnit = getConversionCost(srcMat.type, srcMat.quality, needMat.type, needMat.quality);

      if (costPerUnit > 0 && isFinite(costPerUnit)) {
        options.push({ source, srcMat, costPerUnit, efficiency: 1 / costPerUnit });
      }
    }

    options.sort((a, b) => a.costPerUnit - b.costPerUnit);

    for (const opt of options) {
      if (need.quantity <= 0) break;
      if (opt.source.quantity <= 0) continue;

      // Calculate how much we can actually produce with whole number inputs
      const maxProducible = Math.floor(opt.source.quantity / opt.costPerUnit);
      const toProduce = Math.min(maxProducible, need.quantity);

      if (toProduce > 0) {
        // Calculate the exact whole number of source materials needed
        const consumed = Math.ceil(toProduce * opt.costPerUnit);

        // Ensure we don't consume more than we have
        const actualConsumed = Math.min(consumed, opt.source.quantity);

        // Recalculate actual production based on whole number consumption
        const actualProduced = Math.floor(actualConsumed / opt.costPerUnit);

        // Only proceed if we can actually produce something
        if (actualProduced > 0 && actualConsumed <= opt.source.quantity) {
          // Calculate how much we actually fulfill
          const toFulfill = Math.min(actualProduced, need.quantity);

          // For upgrades, check if there will be a remainder
          // If so, include it in the input amount for the trade
          let inputForTrade = actualConsumed;
          if (opt.srcMat.quality < needMat.quality) {
            // This is an upgrade - check for remainder
            const remainder = opt.source.quantity - actualConsumed;
            if (remainder > 0 && remainder < opt.costPerUnit) {
              // Include the remainder in the trade input (but don't consume it from inventory)
              inputForTrade = actualConsumed + remainder;
            }
          }

          opt.source.quantity -= actualConsumed;
          need.quantity -= toFulfill;

          const tradeSteps = generateTradeSteps(opt.srcMat, needMat, inputForTrade, toFulfill, need.quantity + toFulfill);

          // Check if the trades produced more than needed at the target quality
          // This happens with single-level downgrades where we can't leave remainder at higher quality
          const qualityDiff = Math.abs(opt.srcMat.quality - needMat.quality);
          const sameType = opt.srcMat.type === needMat.type;

          // For single-level downgrades of same type, calculate leftover
          if (sameType && qualityDiff === 1 && opt.srcMat.quality > needMat.quality) {
            const leftover = actualProduced - toFulfill;
            if (leftover > 0) {
              const existingLeftover = inv.find(i => i.item === needMat.item);
              if (existingLeftover) {
                existingLeftover.quantity += leftover;
              } else {
                inv.push({ item: needMat.item, quantity: leftover });
              }
            }
          }

          // Always show detailed steps - don't simplify multi-step conversions
          // This allows users to see the full conversion path
          trades.push(...tradeSteps);

          // Add any remainders from intermediate conversion steps back to inventory
          // Skip the first step's remainder as it's already tracked in opt.source.quantity
          for (let i = 1; i < tradeSteps.length; i++) {
            const step = tradeSteps[i];
            if (step.remainder && step.remainder.amount > 0) {
              const existingRemainder = inv.find(item => item.item === step.remainder.item);
              if (existingRemainder) {
                existingRemainder.quantity += step.remainder.amount;
              } else {
                inv.push({ item: step.remainder.item, quantity: step.remainder.amount });
              }
            }
          }

          fulfilled.push({
            item: need.item,
            quantity: toFulfill,
            method: 'CONVERTED',
            from: opt.source.item,
            consumed: actualConsumed,
            material: needMat
          });
        }
      }
    }

    if (need.quantity > 0) {
      unfulfilled.push({
        item: need.item,
        quantity: need.quantity,
        material: needMat
      });
    }
  }

  // Group trades by base material type
  const groupedTrades = groupTradesByBaseType(trades);
  
  return { 
    trades, 
    groupedTrades,
    fulfilled, 
    unfulfilled, 
    remainingInventory: inv.filter(i => i.quantity > 0) 
  };
}

export function generateTradeSteps(srcMat, targetMat, inputAmount, targetQuantity, totalNeeded) {
  // Find the optimal conversion path that respects integer constraints
  return findOptimalConversionPath(srcMat, targetMat, inputAmount, targetQuantity, totalNeeded);
}

// Find the optimal conversion path that produces exactly the target quantity
// while keeping remainders at the highest possible grade
function findOptimalConversionPath(srcMat, targetMat, availableAmount, targetQuantity, totalNeeded) {
  const steps = [];

  // If same material, no conversion needed
  if (srcMat.item === targetMat.item) {
    return steps;
  }

  // Use direct conversion strategy for better control
  const result = directConversionStrategy(srcMat, targetMat, availableAmount, targetQuantity, totalNeeded);

  return result ? result.steps : [];
}

// Direct conversion strategy - convert step by step
function directConversionStrategy(srcMat, targetMat, inputAmount, targetQuantity, _totalNeeded) {
  const steps = [];
  const currentType = srcMat.type;
  let currentQuality = srcMat.quality;
  let currentAmount = inputAmount;
  let currentItem = srcMat.item;

  // Calculate how much we need at each quality level for cross-type conversions
  const needsCrossType = currentType !== targetMat.type;
  let neededAtTargetQuality = targetQuantity;

  if (needsCrossType) {
    // Work backwards to figure out how much we need at the target quality level
    // before the cross-type conversion
    neededAtTargetQuality = targetQuantity * TRADE_ACROSS_COST;
  }

  // First, handle quality changes within the same type
  if (currentQuality !== targetMat.quality) {
    if (currentQuality < targetMat.quality) {
      // Multi-step upgrade: combine into single trade
      const qualityDiff = targetMat.quality - currentQuality;
      const costPerUnit = Math.pow(TRADE_UP_COST, qualityDiff);

      const output = Math.floor(currentAmount / costPerUnit);
      if (output === 0) {
        // Can't upgrade, return empty steps
        return { steps: [], inputUsed: 0, outputQuantity: 0 };
      }

      const consumed = output * costPerUnit;
      const remainder = currentAmount - consumed;

      const targetItems = getMaterialsAtTypeQuality(currentType, targetMat.quality);
      const targetItem = targetItems[0]?.item || `Grade ${targetMat.quality}`;

      const ratio = qualityDiff === 1 ? '6:1' : `${costPerUnit}:1`;

      const step = {
        action: 'UPGRADE',
        input: { item: currentItem, type: currentType, quality: currentQuality, amount: currentAmount },
        output: { item: targetItem, type: currentType, quality: targetMat.quality, amount: output },
        ratio: ratio
      };

      // Add remainder information if there is one
      if (remainder > 0) {
        step.remainder = {
          item: currentItem,
          type: currentType,
          quality: currentQuality,
          amount: remainder
        };
      }

      steps.push(step);

      currentAmount = output;
      currentQuality = targetMat.quality;
      currentItem = targetItem;
    } else {
      // Downgrade: Use step-by-step approach to leave remainders at highest quality
      const qualityDiff = currentQuality - targetMat.quality;

      // If multiple steps needed and we won't use all material, downgrade incrementally
      if (qualityDiff > 1) {
        // Calculate total yield if we converted everything
        const totalYieldPerUnit = Math.pow(TRADE_DOWN_YIELD, qualityDiff);
        const totalPossibleOutput = currentAmount * totalYieldPerUnit;

        // Determine target amount considering cross-type needs
        let actualTargetQuantity = targetQuantity;
        if (currentType !== targetMat.type) {
          actualTargetQuantity = neededAtTargetQuality;
        }

        // If we'd produce significantly more than needed, downgrade step-by-step
        if (totalPossibleOutput > actualTargetQuantity) {
          // First downgrade one level
          const firstStepOutput = currentAmount * TRADE_DOWN_YIELD;
          const nextQuality = currentQuality - 1;
          const nextQualityItems = getMaterialsAtTypeQuality(currentType, nextQuality);
          const nextQualityItem = nextQualityItems[0]?.item || `Grade ${nextQuality}`;

          steps.push({
            action: 'DOWNGRADE',
            input: { item: currentItem, type: currentType, quality: currentQuality, amount: currentAmount },
            output: { item: nextQualityItem, type: currentType, quality: nextQuality, amount: firstStepOutput },
            ratio: '1:3'
          });

          currentAmount = firstStepOutput;
          currentQuality = nextQuality;
          currentItem = nextQualityItem;

          // Now calculate how much we need from this level
          const remainingQualityDiff = nextQuality - targetMat.quality;
          const remainingYieldPerUnit = Math.pow(TRADE_DOWN_YIELD, remainingQualityDiff);
          const neededAtCurrentLevel = Math.ceil(actualTargetQuantity / remainingYieldPerUnit);
          const amountToConvert = Math.min(currentAmount, neededAtCurrentLevel);

          // If we still have multiple levels, combine the rest
          if (remainingQualityDiff > 0) {
            const output = amountToConvert * remainingYieldPerUnit;
            const targetItems = getMaterialsAtTypeQuality(currentType, targetMat.quality);
            const targetItem = targetItems[0]?.item || `Grade ${targetMat.quality}`;
            const ratio = remainingQualityDiff === 1 ? '1:3' : `1:${remainingYieldPerUnit}`;

            const step = {
              action: 'DOWNGRADE',
              input: { item: currentItem, type: currentType, quality: currentQuality, amount: amountToConvert },
              output: { item: targetItem, type: currentType, quality: targetMat.quality, amount: output },
              ratio: ratio
            };

            const remainder = currentAmount - amountToConvert;
            if (remainder > 0) {
              step.remainder = {
                item: currentItem,
                type: currentType,
                quality: currentQuality,
                amount: remainder
              };
            }

            steps.push(step);
            currentAmount = output;
            currentQuality = targetMat.quality;
            currentItem = targetItem;
          }
        } else {
          // We need most/all of it, so combine into single trade
          const yieldPerUnit = totalYieldPerUnit;
          const output = currentAmount * yieldPerUnit;
          const targetItems = getMaterialsAtTypeQuality(currentType, targetMat.quality);
          const targetItem = targetItems[0]?.item || `Grade ${targetMat.quality}`;
          const ratio = `1:${yieldPerUnit}`;

          steps.push({
            action: 'DOWNGRADE',
            input: { item: currentItem, type: currentType, quality: currentQuality, amount: currentAmount },
            output: { item: targetItem, type: currentType, quality: targetMat.quality, amount: output },
            ratio: ratio
          });

          currentAmount = output;
          currentQuality = targetMat.quality;
          currentItem = targetItem;
        }
      } else {
        // Single level downgrade
        const output = currentAmount * TRADE_DOWN_YIELD;
        const targetItems = getMaterialsAtTypeQuality(currentType, targetMat.quality);
        const targetItem = targetItems[0]?.item || `Grade ${targetMat.quality}`;

        steps.push({
          action: 'DOWNGRADE',
          input: { item: currentItem, type: currentType, quality: currentQuality, amount: currentAmount },
          output: { item: targetItem, type: currentType, quality: targetMat.quality, amount: output },
          ratio: '1:3'
        });

        currentAmount = output;
        currentQuality = targetMat.quality;
        currentItem = targetItem;
      }
    }
  }

  // Then handle type change if needed
  if (currentType !== targetMat.type) {
    // Calculate how much we need to convert for cross-type
    const neededInput = Math.min(currentAmount, targetQuantity * TRADE_ACROSS_COST);
    const actualInput = Math.floor(neededInput / TRADE_ACROSS_COST) * TRADE_ACROSS_COST;

    const output = Math.floor(actualInput / TRADE_ACROSS_COST);
    if (output > 0) {
      const consumed = output * TRADE_ACROSS_COST;
      const remainder = currentAmount - consumed;

      const step = {
        action: 'CROSS_TYPE',
        input: { item: currentItem, type: currentType, quality: currentQuality, amount: actualInput },
        output: { item: targetMat.item, type: targetMat.type, quality: targetMat.quality, amount: output },
        ratio: '6:1'
      };

      // Add remainder information if there is one
      if (remainder > 0) {
        step.remainder = {
          item: currentItem,
          type: currentType,
          quality: currentQuality,
          amount: remainder
        };
      }

      steps.push(step);
      currentAmount = output;
    }
  }

  return {
    steps,
    inputUsed: inputAmount,
    outputQuantity: currentAmount
  };
}


export function calculateBlueprintCosts(selectedBlueprints) {
  const totals = {};

  for (const bp of selectedBlueprints) {
    const moduleData = BLUEPRINTS_DB[bp.module];
    if (!moduleData) continue;

    const blueprintData = moduleData.blueprints[bp.blueprint];
    if (!blueprintData) continue;

    // Get the reroll strategy
    const strategy = REROLL_STRATEGIES[bp.strategy || 'single'];
    if (!strategy) continue;

    for (let g = bp.fromGrade; g <= bp.toGrade; g++) {
      const gradeMats = blueprintData.grades[g];
      if (!gradeMats) continue;

      // Get rolls for this specific grade based on strategy
      const rollsForGrade = strategy.rolls[g] || 1;

      for (const mat of gradeMats) {
        const key = mat.item;
        if (!totals[key]) totals[key] = 0;
        totals[key] += mat.qty * rollsForGrade;
      }
    }
  }

  return Object.entries(totals).map(([item, quantity]) => ({ item, quantity }));
}

// Extract base material type (Raw, Manufactured, Encoded) from material type string
export function getBaseMaterialType(materialType) {
  if (materialType.startsWith('Raw')) return 'Raw';
  if (materialType.startsWith('Manufactured')) return 'Manufactured';
  if (materialType.startsWith('Encoded')) return 'Encoded';
  return 'Unknown';
}

// Check if a trade chain has remainders that would require detailed steps
export function hasTradeRemainders(steps) {
  if (steps.length <= 1) return false;
  
  // Check if any step in the chain produces a remainder
  for (let i = 0; i < steps.length - 1; i++) {
    const currentStep = steps[i];
    
    // For upgrades (6:1 ratio), check if input amount is not perfectly divisible by 6
    if (currentStep.action === 'UPGRADE' && currentStep.input.amount % 6 !== 0) {
      return true;
    }
    
    // For cross-type trades (6:1 ratio), check if input amount is not perfectly divisible by 6
    if (currentStep.action === 'CROSS_TYPE' && currentStep.input.amount % 6 !== 0) {
      return true;
    }
  }
  
  return false;
}

// Create a simplified direct conversion from a chain of trade steps
export function simplifyTradeChain(steps) {
  if (steps.length === 0) return null;
  if (steps.length === 1) return steps[0];
  
  const firstStep = steps[0];
  const lastStep = steps[steps.length - 1];
  
  // Calculate the overall conversion ratio
  let totalRatio = 1;
  for (const step of steps) {
    if (step.action === 'UPGRADE' || step.action === 'CROSS_TYPE') {
      totalRatio *= 6; // 6:1 ratio
    } else if (step.action === 'DOWNGRADE') {
      totalRatio /= 3; // 1:3 ratio
    }
  }
  
  return {
    action: 'DIRECT_CONVERSION',
    input: firstStep.input,
    output: lastStep.output,
    ratio: `${Math.round(totalRatio)}:1`,
    originalSteps: steps
  };
}

// Group trades by base material type (Raw, Manufactured, Encoded)
export function groupTradesByBaseType(trades) {
  const groups = {
    'Raw': [],
    'Manufactured': [],
    'Encoded': []
  };
  
  for (const trade of trades) {
    // Determine the base type from the input material (the material being traded away)
    const baseType = getBaseMaterialType(trade.input.type);
    if (groups[baseType]) {
      groups[baseType].push(trade);
    }
  }
  
  // Filter out empty groups
  const result = {};
  for (const [type, tradeList] of Object.entries(groups)) {
    if (tradeList.length > 0) {
      result[type] = tradeList;
    }
  }
  
  return result;
}
